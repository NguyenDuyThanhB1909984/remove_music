name: multi job  Remove Audio

on:
  workflow_dispatch:

jobs:
  define-videos:
    runs-on: ubuntu-latest
    outputs:
      videos: ${{ steps.get-videos.outputs.videos }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
           python-version: '3.8'

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get upgrade -y
          pip install gdown
          pip install --upgrade gdown

      - name: Create videos folder
        run: mkdir -p $GITHUB_WORKSPACE/videos

      - name: Get Videos
        id: get-videos
        run: |
          echo 'videos=["https://drive.google.com/uc?export=download&id=1xZQlmnligBouXd3LRoOReAqG4eJuaMtg"]' >> $GITHUB_OUTPUT

  process-videos:
    needs: define-videos
    runs-on: ubuntu-latest
    strategy:
      matrix:
        video: ${{ fromJSON(needs.define-videos.outputs.videos) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
           python-version: '3.8'

      - name: Install dependencies
        run: |
          sudo apt-get update && sudo apt-get upgrade -y
          sudo apt-get install -y software-properties-common
          sudo add-apt-repository -y ppa:savoury1/ffmpeg4
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          pip install demucs
          pip install gdown
          pip install --upgrade gdown

      - name: Create user folders
        run: mkdir -p $GITHUB_WORKSPACE/videos

      - name: Download video
        run: gdown --url ${{ matrix.video }} -O $GITHUB_WORKSPACE/videos/video.mp4

      - name: Run python script
        run: python remove_audio.py
        
      - name: Archive processed video
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: processed_video_${{ matrix.video }}
          path: videos_without_music
